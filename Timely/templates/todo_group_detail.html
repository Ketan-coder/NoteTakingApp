{% extends "base.html" %}
{% load static %}

{% block title %}{{ group.title }} - Todo Board{% endblock %}

{% block head %}
<style>
  .not-started-bg { background-color: #94a3b8; color: white; }
  .in-progress-bg { background-color: #60a5fa; color: white; }
  .completed-bg   { background-color: #34d399; color: white; }
  .on-hold-bg     { background-color: #fcd34d; color: black; }
  .cancelled-bg   { background-color: #f87171; color: white; }

  .todo-card {
    padding: 0.75rem;
    border-radius: var(--bs-card-border-radius);
    cursor: grab;
    margin-bottom: 1rem;
    transition: transform 0.1s ease-in-out;
  }
  .todo-card:active {
    cursor: grabbing;
    transform: scale(1.02);
  }

  .todo-column {
    min-height: 70vh;
    background-color: var(--bs-dark);
    padding: var(--bs-card-spacer-y);
    border-radius: var(--bs-border-radius-lg);
    box-shadow: var(--bs-box-shadow-lg);
  }

  .form-inline-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .form-inline-group .form-control {
    flex-grow: 1;
    min-width: 100px;
  }

  .btn-icon-only {
    display: flex;
    justify-content: center;
    align-items: center;
    min-width: 36px;
    padding: 0.5rem;
  }

  .btn-icon-only svg {
    width: 1em;
    height: 1em;
    fill: #ef4444;
  }

  .htmx-indicator {
    display: none;
    margin-left: 10px;
    color: var(--bs-primary);
  }
  .htmx-request .htmx-indicator {
    display: inline-block;
  }

  .progress-bar {
    height: 6px;
    background-color: var(--bs-primary);
    margin-bottom: 0.75rem;
    border-radius: 9999px;
  }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
      <h1 class="display-4 text-white">{{ group.title }}</h1>
      <div class="btn-group">
        {% if group.author == request.user.profile %}
        <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#deleteGroupModal-{{ group.id }}">
          Delete Group
        </button>
        {% if group.shared_with.exists %}
        <a class="btn btn-secondary" href="{% url 'stopSharingTodoGroup' pk=group.id %}"
           hx-confirm="Are you sure you want to unshare this group? This will remove access for all users."
           hx-target="this"
           hx-swap="outerHTML">
          Unshare Group
        </a>
        {% endif %}
        <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#shareTaskModal-{{group.id}}">
          Share Group
        </button>
        {% endif %}
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
          + Add Task
        </button>
      </div>
    </div>
  </div>

  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-5 g-4">
    {% for status, todos in status_groups.items %}
    <div class="col">
      <div class="card h-100">
        <h5 class="card-title text-center">{{ status }}</h5>
        <div class="progress-bar-container px-3">
          <div class="progress-bar" id="progress-{{ status|slugify }}" style="width: {{ todos|length }}0%;"></div>
        </div>
        <div class="card-body todo-column" id="list-{{ status|slugify }}" data-status="{{ status }}">
          {% for todo in todos %}
          <div class="card todo-card {{ status|slugify }}-bg" id="todo-{{ todo.todo_uuid }}" data-id="{{ todo.todo_uuid }}">
            <form
              hx-post="{% url 'edit_task' todo_uuid=todo.todo_uuid %}"
              hx-trigger="keyup changed delay:500ms from:input"
              hx-target="#todo-{{ todo.todo_uuid }}"
              hx-swap="outerHTML"
              class="form-inline-group"
            >
              {% csrf_token %}
              <input type="hidden" name="todo_uuid" value="{{ todo.todo_uuid }}">
              <div class="input-group">
                <input type="text" name="title" class="form-control" value="{{ todo.title }}" placeholder="Task title">
                <button type="button" class="btn btn-sm btn-secondary btn-icon-only"
                        hx-post="{% url 'delete_task' todo_uuid=todo.todo_uuid %}"
                        hx-target="#todo-{{ todo.todo_uuid }}"
                        hx-swap="outerHTML"
                        hx-confirm="Are you sure you want to delete this task?">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                    <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z"/>
                  </svg>
                </button>
              </div>
              <span class="htmx-indicator">Saving...</span>
            </form>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>


<div class="modal fade" id="shareTaskModal-{{ group.id }}" tabindex="-1" aria-labelledby="sharegroupLabel-{{ group.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sharegroupLabel-{{ group.id }}">Share group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'startingSharedTodoGroup' group.id %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Are you sure you want to share the group <i class="fas fa-book"></i> "<strong>{{ group.title }}</strong>"?</p>

                    <div class="mb-3">
                        <label for="sharedEmails-{{ group.id }}" class="form-label">
                            Enter Emails to Share With (Separate multiple emails with commas):
                        </label>
                        <input type="text" class="form-control" id="sharedEmails-{{ group.id }}"
                               name="shared_to_emails" placeholder="Enter emails, separated by commas"
                               hx-get="{% url 'fetch_profile_details' %}"
                               hx-trigger="keyup changed delay:500ms"
                               hx-target="#profile-info-{{ group.id }}"
                               hx-indicator=".htmx-indicator"
                               oninput="toggleCheckbox({{ group.id }})">
                    </div>

                    <!-- HTMX Loading Indicator -->
                    <div class="htmx-indicator" style="display: none;">
                        <p>Loading...</p>
                    </div>
                    
                    <hr id="hr-{{ group.id }}" style="display: none;">
                    <!-- HTMX Box for Displaying User Info -->
                    <div id="profile-info-{{ group.id }}" style="display: none;"></div>

                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger" id="shareButton-{{ group.id }}">Make it Public</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="addTaskModal" tabindex="-1" role="dialog" aria-labelledby="addTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered w-400" role="document">
    <div class="modal-content p-20">
      <div class="modal-header">
        <h5 class="modal-title" id="addTaskModalLabel">üìù Add New Task</h5>
        <button type="button" class="close" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form
        hx-post="{% url 'add_task' group.todogroup_uuid %}"
        hx-target="#list-not-started"
        hx-swap="beforeend"
        hx-on::after-request="this.reset(); updateProgressBars();"
      >
        {% csrf_token %}
        <div class="modal-body">
          <div class="form-group">
            <label for="title" class="required">Title</label>
            <input type="text" id="title" name="title" required class="form-control" placeholder="Enter task title">
          </div>
          <div class="form-group">
            <label for="priority">Priority</label>
            <select id="priority" name="priority" class="form-control">
              <option value="">Select Priority</option>
              <option>Low</option>
              <option>Medium</option>
              <option>High</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
             Add Task
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  function updateCardClass(todoEl, newStatus) {
    const classes = ['not-started-bg', 'in-progress-bg', 'completed-bg', 'on-hold-bg', 'cancelled-bg'];
    classes.forEach(cls => todoEl.classList.remove(cls));
    todoEl.classList.add(`${newStatus.toLowerCase().replace(/ /g, '-')}-bg`);
  }

  function updateProgressBars() {
    document.querySelectorAll('.todo-column').forEach(column => {
      const bar = document.querySelector(`#progress-${column.dataset.status.toLowerCase().replace(/ /g, '-')}`);
      const count = column.querySelectorAll('.todo-card').length;
      bar.style.width = `${Math.min(count * 10, 100)}%`;
    });
  }

  document.querySelectorAll('.todo-column').forEach(column => {
    new Sortable(column, {
      group: 'shared',
      animation: 150,
      ghostClass: 'sortable-ghost',
      chosenClass: 'sortable-chosen',
      dragClass: 'sortable-drag',

      onEnd: function (evt) {
        const todoEl = evt.item;
        const todoId = todoEl.dataset.id;
        const newStatus = evt.to.dataset.status;

        fetch("/todo/update-status/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
          },
          body: JSON.stringify({
            todo_uuid: todoId,
            new_status: newStatus
          })
        }).then(res => {
          if (!res.ok) return alert("Failed to update status.");
          updateCardClass(todoEl, newStatus);
          updateProgressBars();
        });
      }
    });
  });

  document.addEventListener("DOMContentLoaded", updateProgressBars);
</script>

<script>
  function toggleCheckbox(notebookId) {
      let emailInput = document.getElementById("sharedEmails-" + notebookId); 
      let hr = document.getElementById("hr-" + notebookId);
      let shareButton = document.getElementById("shareButton-" + notebookId);

      if (emailInput.value.trim() === "") {
      } else {
        shareButton.textContent = "Share TodoGroup";
        shareButton.classList.remove("btn-danger");
        shareButton.classList.add("btn-primary");
        hr.style.display = "block";
      }
  }

  document.body.addEventListener("htmx:afterSwap", function(event) {
      let targetId = event.detail.elt.id;
      console.log("HTMX afterSwap event for target:", targetId);
      if (targetId.startsWith("profile-info-")) {
          let targetElement = document.getElementById(targetId);
          targetElement.style.display = "block";
      }
  });
</script>
{% endblock %}
